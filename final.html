<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <title>Tarjeta Final</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin:0; background:black; display:flex; flex-direction:column; align-items:center; 
           font-family:'Montserrat',sans-serif; color:white; padding:1rem; }
    .preloader { position:fixed; top:0; left:0; width:100vw; height:100vh; background:black; 
                 display:flex; flex-wrap:wrap; align-items:center; justify-content:center; z-index:999;}
    .ball { width:40px; height:24px; background:url('https://upload.wikimedia.org/wikipedia/commons/thumb/b/be/Rugby_ball_Transparent.svg/1024px-Rugby_ball_Transparent.svg.png') no-repeat center/contain; 
             position:absolute; animation:float 3s ease-in-out forwards; }
    @keyframes float {0%{transform:translateY(100vh) rotate(0deg);opacity:1;}100%{transform:translateY(-100vh) rotate(360deg);opacity:0;}}
    .card-container { width:90vw; max-width:400px; aspect-ratio:1/1; position:relative; }
    #card { width:100%; height:100%; background:url('panamcard.png') center/cover no-repeat; position:relative; 
            opacity:0; transform:translateY(20px) scale(0.95); transition:all 0.5s ease-out; }
    #card.show { opacity:1; transform:translateY(0) scale(1); }
    .avatar-wrapper { position:absolute; top:20%; left:50%; width:20%; aspect-ratio:1/1; overflow:hidden; 
                       transform:translateX(-50%); }
    .avatar-wrapper img { width:100%; height:100%; object-fit:cover; }
    .stat-label, .stat-value { position:absolute; color:white; font-size:3vw; font-weight:bold; }
    #label1 { top:60%; left:35%; transform:translateX(-100%); }
    #value1 { top:60%; left:65%; }
    #label2 { top:70%; left:35%; transform:translateX(-100%); }
    #value2 { top:70%; left:65%; }
    #label3 { top:80%; left:35%; transform:translateX(-100%); }
    #value3 { top:80%; left:65%; }
    button { margin:0.5rem; padding:0.5rem 1rem; border:none; border-radius:5px; font-weight:bold; cursor:pointer; }
    #shareBtn { background:#e1306c; color:white; }
    #downloadBtn { background:#FFD700; color:black; }
    canvas { display:none; }
  </style>
</head>
<body onload="iniciar()">
  <div class="preloader" id="preloader"></div>
  <div class="card-container">
    <div id="card">
      <div class="avatar-wrapper"><img id="avatar" src="" alt="Avatar"/></div>
      <div id="label1" class="stat-label">FRZ</div><div id="value1" class="stat-value"></div>
      <div id="label2" class="stat-label">VEL</div><div id="value2" class="stat-value"></div>
      <div id="label3" class="stat-label">RES</div><div id="value3" class="stat-value"></div>
    </div>
  </div>
  <button id="shareBtn" onclick="shareStory()">Compartir en Instagram</button>
  <button id="downloadBtn" onclick="downloadCard()">Descargar</button>
  <canvas id="snapshot" width="224" height="224"></canvas>
  <script>
    function iniciar() {
      const pre = document.getElementById('preloader');
      for (let i = 0; i < 12; i++) {
        const b = document.createElement('div');
        b.className = 'ball';
        b.style.left = Math.random()*100 + 'vw';
        b.style.top  = Math.random()*100 + 'vh';
        pre.appendChild(b);
      }
      setTimeout(() => {
        document.getElementById('preloader').remove();
        renderCard();
      }, 2000);
    }
    function renderCard() {
      const dataURL = localStorage.getItem('foto');
      document.getElementById('avatar').src = dataURL;
      document.getElementById('value1').innerText = localStorage.getItem('d1');
      document.getElementById('value2').innerText = localStorage.getItem('d2');
      document.getElementById('value3').innerText = localStorage.getItem('d3');
      document.getElementById('card').classList.add('show');
    }
    function shareStory() {
      html2canvas(document.getElementById('card')).then(canvas => {
        canvas.toBlob(blob => {
          const reader = new FileReader();
          reader.onload = () => {
            const dataURL = reader.result;
            window.location.href = 'instagram://story-camera?background_image=' + encodeURIComponent(dataURL);
          };
          reader.readAsDataURL(blob);
        });
      });
    }
    function downloadCard() {
      html2canvas(document.getElementById('card')).then(canvas => {
        const a = document.createElement('a');
        a.download = 'tarjeta.png';
        a.href = canvas.toDataURL();
        a.click();
      });
    }
  </script>
</body>
</html>